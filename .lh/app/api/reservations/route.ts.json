{
    "sourceFile": "app/api/reservations/route.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1770978593407,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1770978593407,
            "name": "Commit-0",
            "content": "import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@/lib/supabase/server'\n\nconst PHONE_REGEX = /^01[0-9]?[0-9]{3,4}[0-9]{4}$/\n\nfunction getClientIp(request: NextRequest): string {\n  return (\n    request.headers.get('x-forwarded-for')?.split(',')[0]?.trim() ||\n    request.headers.get('x-real-ip') ||\n    'unknown'\n  )\n}\n\nconst rateLimitMap = new Map<string, { count: number; resetTime: number }>()\n\nfunction checkRateLimit(ip: string): boolean {\n  const now = Date.now()\n  const entry = rateLimitMap.get(ip)\n\n  if (!entry || now > entry.resetTime) {\n    rateLimitMap.set(ip, { count: 1, resetTime: now + 60_000 })\n    return true\n  }\n\n  if (entry.count >= 10) {\n    return false\n  }\n\n  entry.count++\n  return true\n}\n\nexport async function POST(request: NextRequest) {\n  const ip = getClientIp(request)\n\n  if (!checkRateLimit(ip)) {\n    return NextResponse.json(\n      { error: '요청이 너무 많습니다. 잠시 후 다시 시도해주세요.' },\n      { status: 429 }\n    )\n  }\n\n  let body: {\n    product_id?: string\n    customer_name?: string\n    customer_phone?: string\n    quantity?: number\n    pickup_date?: string | null\n    memo?: string | null\n    privacy_agreed?: boolean\n  }\n\n  try {\n    body = await request.json()\n  } catch {\n    return NextResponse.json({ error: '잘못된 요청입니다' }, { status: 400 })\n  }\n\n  const { product_id, customer_name, customer_phone, quantity, pickup_date, memo, privacy_agreed } = body\n\n  if (!product_id || !customer_name?.trim() || !customer_phone || !quantity) {\n    return NextResponse.json({ error: '필수 항목을 입력해주세요' }, { status: 400 })\n  }\n\n  const normalizedPhone = customer_phone.replace(/-/g, '')\n  if (!PHONE_REGEX.test(normalizedPhone)) {\n    return NextResponse.json(\n      { error: '전화번호 형식이 올바르지 않습니다' },\n      { status: 400 }\n    )\n  }\n\n  if (quantity < 1 || quantity > 99) {\n    return NextResponse.json({ error: '수량이 올바르지 않습니다' }, { status: 400 })\n  }\n\n  if (!privacy_agreed) {\n    return NextResponse.json(\n      { error: '개인정보 동의가 필요합니다' },\n      { status: 400 }\n    )\n  }\n\n  const supabase = await createClient()\n\n  const { data: product } = await supabase\n    .from('products')\n    .select('shop_id')\n    .eq('id', product_id)\n    .single()\n\n  if (!product?.shop_id) {\n    return NextResponse.json({ error: '상품을 찾을 수 없습니다' }, { status: 404 })\n  }\n\n  const { data, error } = await supabase.rpc('create_reservation', {\n    p_product_id: product_id,\n    p_shop_id: product.shop_id,\n    p_customer_name: customer_name.trim(),\n    p_customer_phone: normalizedPhone,\n    p_quantity: quantity,\n    p_pickup_date: pickup_date || null,\n    p_memo: memo?.trim() || null,\n    p_privacy_agreed: privacy_agreed,\n  })\n\n  if (error) {\n    if (error.message?.includes('수량') || error.message?.includes('quantity') || error.message?.includes('sold out')) {\n      return NextResponse.json(\n        { error: '재고가 부족합니다. 수량을 확인해주세요.' },\n        { status: 409 }\n      )\n    }\n    return NextResponse.json(\n      { error: '예약에 실패했습니다. 잠시 후 다시 시도해주세요.' },\n      { status: 500 }\n    )\n  }\n\n  return NextResponse.json(\n    {\n      reservation: {\n        id: data.id,\n        customer_name: data.customer_name,\n        quantity: data.quantity,\n        pickup_date: data.pickup_date,\n        status: data.status,\n      },\n    },\n    { status: 201 }\n  )\n}\n"
        }
    ]
}