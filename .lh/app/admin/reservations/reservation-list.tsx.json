{
    "sourceFile": "app/admin/reservations/reservation-list.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1770983456677,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770983544002,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -93,14 +93,14 @@\n     setIsSelectionMode(false)\n     setSelectedIds(new Set())\n   }\n \n-  async function handleBulkStatus(newStatus: 'confirmed' | 'cancelled') {\n+  async function handleBulkStatus(newStatus: 'confirmed' | 'cancelled' | 'completed') {\n     if (selectedIds.size === 0) {\n       toast.error('예약을 선택해주세요')\n       return\n     }\n-    const action = newStatus === 'confirmed' ? '확인' : '취소'\n+    const action = newStatus === 'confirmed' ? '확인' : newStatus === 'cancelled' ? '취소' : '완료'\n     if (!confirm(`선택한 ${selectedIds.size}건 예약을 일괄 ${action} 처리할까요?`)) return\n     setBulkUpdating(true)\n     try {\n       const result = await updateReservationsStatusBulk(Array.from(selectedIds), newStatus)\n@@ -170,8 +170,18 @@\n                     onClick={() => handleBulkStatus('cancelled')}\n                   >\n                     일괄 취소 {selectedIds.size > 0 ? `(${selectedIds.size})` : ''}\n                   </Button>\n+                  <Button\n+                    type=\"button\"\n+                    variant=\"outline\"\n+                    size=\"sm\"\n+                    className=\"h-9\"\n+                    disabled={selectedIds.size === 0 || bulkUpdating}\n+                    onClick={() => handleBulkStatus('completed')}\n+                  >\n+                    일괄 완료 {selectedIds.size > 0 ? `(${selectedIds.size})` : ''}\n+                  </Button>\n                 </div>\n               )}\n             </>\n           )}\n"
                },
                {
                    "date": 1770984178457,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n \n import { useState } from 'react'\n import { useRouter } from 'next/navigation'\n import Link from 'next/link'\n-import { Calendar, Package } from 'lucide-react'\n+import { Calendar, Package, FileDown } from 'lucide-react'\n import { Button } from '@/components/ui/button'\n import { Checkbox } from '@/components/ui/checkbox'\n import { formatKoreanWon } from '@/lib/utils'\n import { updateReservationStatus, updateReservationsStatusBulk } from './actions'\n@@ -52,8 +52,39 @@\n   cancelled: '취소됨',\n   completed: '완료',\n }\n \n+function buildReservationsCsv(reservations: Reservation[]): string {\n+  const BOM = '\\uFEFF'\n+  const headers = ['예약일시', '상품명', '예약자', '연락처', '수량', '단가', '금액', '픽업희망일', '메모', '상태']\n+  const escape = (v: string | number | null | undefined): string => {\n+    if (v == null) return ''\n+    const s = String(v).replace(/\"/g, '\"\"')\n+    return s.includes(',') || s.includes('\"') || s.includes('\\n') ? `\"${s}\"` : s\n+  }\n+  const rows = reservations.map((r) => {\n+    const product = r.products as { title?: string; price?: number } | null\n+    const title = product?.title ?? ''\n+    const price = product?.price ?? 0\n+    const amount = price * r.quantity\n+    const dateStr = r.created_at ? formatDateTime(r.created_at) : ''\n+    const pickupStr = r.pickup_date ? new Date(r.pickup_date).toLocaleDateString('ko-KR') : ''\n+    return [\n+      dateStr,\n+      title,\n+      r.customer_name,\n+      r.customer_phone,\n+      r.quantity,\n+      price,\n+      amount,\n+      pickupStr,\n+      r.memo ?? '',\n+      STATUS_LABELS[r.status],\n+    ].map((val) => escape(val)).join(',')\n+  })\n+  return BOM + [headers.join(','), ...rows].join('\\n')\n+}\n+\n function formatDate(dateString: string): string {\n   const d = new Date(dateString)\n   return `${d.getMonth() + 1}/${d.getDate()}`\n }\n@@ -93,8 +124,24 @@\n     setIsSelectionMode(false)\n     setSelectedIds(new Set())\n   }\n \n+  function handleExcelDownload() {\n+    if (reservations.length === 0) {\n+      toast.error('다운로드할 예약이 없습니다')\n+      return\n+    }\n+    const csv = buildReservationsCsv(reservations)\n+    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' })\n+    const url = URL.createObjectURL(blob)\n+    const a = document.createElement('a')\n+    a.href = url\n+    a.download = `예약목록_${new Date().toISOString().slice(0, 10)}.csv`\n+    a.click()\n+    URL.revokeObjectURL(url)\n+    toast.success('엑셀 파일이 다운로드되었습니다')\n+  }\n+\n   async function handleBulkStatus(newStatus: 'confirmed' | 'cancelled' | 'completed') {\n     if (selectedIds.size === 0) {\n       toast.error('예약을 선택해주세요')\n       return\n@@ -130,17 +177,29 @@\n           <h1 className=\"text-xl font-bold text-stone-900\">예약 관리</h1>\n           {reservations.length > 0 && (\n             <>\n               {!isSelectionMode ? (\n-                <Button\n-                  type=\"button\"\n-                  variant=\"outline\"\n-                  size=\"sm\"\n-                  className=\"h-9\"\n-                  onClick={() => setIsSelectionMode(true)}\n-                >\n-                  일괄 처리\n-                </Button>\n+                <div className=\"flex items-center gap-2\">\n+                  <Button\n+                    type=\"button\"\n+                    variant=\"outline\"\n+                    size=\"sm\"\n+                    className=\"h-9\"\n+                    onClick={handleExcelDownload}\n+                  >\n+                    <FileDown className=\"h-4 w-4 mr-1.5\" />\n+                    엑셀 다운로드\n+                  </Button>\n+                  <Button\n+                    type=\"button\"\n+                    variant=\"outline\"\n+                    size=\"sm\"\n+                    className=\"h-9\"\n+                    onClick={() => setIsSelectionMode(true)}\n+                  >\n+                    일괄 처리\n+                  </Button>\n+                </div>\n               ) : (\n                 <div className=\"flex items-center gap-2\">\n                   <Button\n                     type=\"button\"\n"
                },
                {
                    "date": 1770984220131,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -157,10 +157,11 @@\n         toast.success(`${selectedIds.size}건 ${action} 처리되었습니다`)\n         exitSelectionMode()\n         router.refresh()\n       }\n-    } catch (e: any) {\n-      toast.error(e?.message || '일괄 처리에 실패했습니다')\n+    } catch (e: unknown) {\n+      const message = e instanceof Error ? e.message : '일괄 처리에 실패했습니다'\n+      toast.error(message)\n     } finally {\n       setBulkUpdating(false)\n     }\n   }\n"
                },
                {
                    "date": 1770984233533,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -303,10 +303,11 @@\n                   try {\n                     await updateReservationStatus(reservation.id, newStatus)\n                     toast.success('예약 상태가 변경되었습니다')\n                     router.refresh()\n-                  } catch (error: any) {\n-                    toast.error(error.message || '상태 변경에 실패했습니다')\n+                  } catch (error: unknown) {\n+                    const message = error instanceof Error ? error.message : '상태 변경에 실패했습니다'\n+                    toast.error(message)\n                   }\n                 }}\n               />\n             ))}\n"
                }
            ],
            "date": 1770983456677,
            "name": "Commit-0",
            "content": "'use client'\n\nimport { useState } from 'react'\nimport { useRouter } from 'next/navigation'\nimport Link from 'next/link'\nimport { Calendar, Package } from 'lucide-react'\nimport { Button } from '@/components/ui/button'\nimport { Checkbox } from '@/components/ui/checkbox'\nimport { formatKoreanWon } from '@/lib/utils'\nimport { updateReservationStatus, updateReservationsStatusBulk } from './actions'\nimport toast, { Toaster } from 'react-hot-toast'\n\ninterface Reservation {\n  id: string\n  customer_name: string\n  customer_phone: string\n  quantity: number\n  pickup_date: string | null\n  memo: string | null\n  status: 'pending' | 'confirmed' | 'cancelled' | 'completed'\n  created_at: string\n  products: {\n    title: string\n    price: number\n    image_url: string | null\n  }\n}\n\nconst DATE_FILTERS = [\n  { key: 'all', label: '전체' },\n  { key: 'today', label: '오늘' },\n] as const\n\nconst STATUS_FILTERS = [\n  { key: 'all', label: '전체' },\n  { key: 'pending', label: '대기중' },\n  { key: 'confirmed', label: '확인됨' },\n  { key: 'cancelled', label: '취소됨' },\n  { key: 'completed', label: '완료' },\n] as const\n\nconst STATUS_STYLES = {\n  pending: 'bg-yellow-50 text-yellow-700 border-yellow-200',\n  confirmed: 'bg-green-50 text-green-700 border-green-200',\n  cancelled: 'bg-red-50 text-red-700 border-red-200',\n  completed: 'bg-stone-100 text-stone-600 border-stone-200',\n}\n\nconst STATUS_LABELS = {\n  pending: '대기중',\n  confirmed: '확인됨',\n  cancelled: '취소됨',\n  completed: '완료',\n}\n\nfunction formatDate(dateString: string): string {\n  const d = new Date(dateString)\n  return `${d.getMonth() + 1}/${d.getDate()}`\n}\n\nfunction formatDateTime(dateString: string): string {\n  const d = new Date(dateString)\n  return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`\n}\n\nexport function ReservationList({\n  reservations,\n  shopSlug,\n}: {\n  reservations: Reservation[]\n  shopSlug: string\n}) {\n  const router = useRouter()\n  const [isSelectionMode, setIsSelectionMode] = useState(false)\n  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set())\n  const [bulkUpdating, setBulkUpdating] = useState(false)\n\n  const toggleSelect = (id: string) => {\n    setSelectedIds((prev) => {\n      const next = new Set(prev)\n      if (next.has(id)) next.delete(id)\n      else next.add(id)\n      return next\n    })\n  }\n\n  const toggleSelectAll = () => {\n    if (selectedIds.size === reservations.length) setSelectedIds(new Set())\n    else setSelectedIds(new Set(reservations.map((r) => r.id)))\n  }\n\n  function exitSelectionMode() {\n    setIsSelectionMode(false)\n    setSelectedIds(new Set())\n  }\n\n  async function handleBulkStatus(newStatus: 'confirmed' | 'cancelled') {\n    if (selectedIds.size === 0) {\n      toast.error('예약을 선택해주세요')\n      return\n    }\n    const action = newStatus === 'confirmed' ? '확인' : '취소'\n    if (!confirm(`선택한 ${selectedIds.size}건 예약을 일괄 ${action} 처리할까요?`)) return\n    setBulkUpdating(true)\n    try {\n      const result = await updateReservationsStatusBulk(Array.from(selectedIds), newStatus)\n      if (result?.error) {\n        toast.error(result.error)\n      } else {\n        toast.success(`${selectedIds.size}건 ${action} 처리되었습니다`)\n        exitSelectionMode()\n        router.refresh()\n      }\n    } catch (e: any) {\n      toast.error(e?.message || '일괄 처리에 실패했습니다')\n    } finally {\n      setBulkUpdating(false)\n    }\n  }\n\n  return (\n    <>\n      <Toaster\n        position=\"top-center\"\n        toastOptions={{ className: 'text-sm font-medium', duration: 3000 }}\n      />\n\n      <div className=\"space-y-5\">\n        <div className=\"flex flex-wrap items-center justify-between gap-3\">\n          <h1 className=\"text-xl font-bold text-stone-900\">예약 관리</h1>\n          {reservations.length > 0 && (\n            <>\n              {!isSelectionMode ? (\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"sm\"\n                  className=\"h-9\"\n                  onClick={() => setIsSelectionMode(true)}\n                >\n                  일괄 처리\n                </Button>\n              ) : (\n                <div className=\"flex items-center gap-2\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"h-9\"\n                    onClick={exitSelectionMode}\n                  >\n                    취소\n                  </Button>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"h-9 border-green-200 text-green-700 hover:bg-green-50\"\n                    disabled={selectedIds.size === 0 || bulkUpdating}\n                    onClick={() => handleBulkStatus('confirmed')}\n                  >\n                    일괄 확인 {selectedIds.size > 0 ? `(${selectedIds.size})` : ''}\n                  </Button>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"h-9 border-red-200 text-red-700 hover:bg-red-50\"\n                    disabled={selectedIds.size === 0 || bulkUpdating}\n                    onClick={() => handleBulkStatus('cancelled')}\n                  >\n                    일괄 취소 {selectedIds.size > 0 ? `(${selectedIds.size})` : ''}\n                  </Button>\n                </div>\n              )}\n            </>\n          )}\n        </div>\n\n        <div className=\"space-y-3\">\n          <div className=\"flex gap-2\">\n            {DATE_FILTERS.map((f) => (\n              <Link\n                key={f.key}\n                href={f.key === 'all' ? '/admin/reservations' : `/admin/reservations?date=${f.key}`}\n                className=\"rounded-lg px-3.5 py-1.5 text-sm font-medium transition-colors bg-white text-stone-500 border border-stone-200 hover:bg-stone-50 hover:text-stone-700\"\n              >\n                {f.label}\n              </Link>\n            ))}\n          </div>\n\n          <div className=\"flex gap-2 flex-wrap\">\n            {STATUS_FILTERS.map((f) => (\n              <Link\n                key={f.key}\n                href={f.key === 'all' ? '/admin/reservations' : `/admin/reservations?status=${f.key}`}\n                className=\"rounded-lg px-3.5 py-1.5 text-sm font-medium transition-colors bg-white text-stone-500 border border-stone-200 hover:bg-stone-50 hover:text-stone-700\"\n              >\n                {f.label}\n              </Link>\n            ))}\n          </div>\n        </div>\n\n        {reservations.length === 0 ? (\n          <div className=\"rounded-2xl border border-stone-200 bg-white py-16 text-center shadow-sm\">\n            <Calendar className=\"mx-auto h-10 w-10 text-stone-300\" />\n            <p className=\"mt-3 text-sm text-stone-400\">예약이 없습니다</p>\n          </div>\n        ) : (\n          <div className=\"grid gap-3\">\n            {isSelectionMode && reservations.length > 0 && (\n              <div className=\"flex items-center gap-2 rounded-lg border border-stone-200 bg-stone-50 px-3 py-2\">\n                <Checkbox\n                  id=\"select-all-reservations\"\n                  checked={selectedIds.size === reservations.length}\n                  onCheckedChange={toggleSelectAll}\n                />\n                <label htmlFor=\"select-all-reservations\" className=\"text-sm text-stone-600 cursor-pointer\">\n                  전체 선택\n                </label>\n              </div>\n            )}\n            {reservations.map((reservation) => (\n              <ReservationCard\n                key={reservation.id}\n                reservation={reservation}\n                isSelectionMode={isSelectionMode}\n                selected={selectedIds.has(reservation.id)}\n                onSelectChange={() => toggleSelect(reservation.id)}\n                onStatusChange={async (newStatus) => {\n                  try {\n                    await updateReservationStatus(reservation.id, newStatus)\n                    toast.success('예약 상태가 변경되었습니다')\n                    router.refresh()\n                  } catch (error: any) {\n                    toast.error(error.message || '상태 변경에 실패했습니다')\n                  }\n                }}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n    </>\n  )\n}\n\nfunction ReservationCard({\n  reservation,\n  isSelectionMode,\n  selected,\n  onSelectChange,\n  onStatusChange,\n}: {\n  reservation: Reservation\n  isSelectionMode: boolean\n  selected: boolean\n  onSelectChange: () => void\n  onStatusChange: (newStatus: 'confirmed' | 'cancelled' | 'completed') => void\n}) {\n  const [updating, setUpdating] = useState(false)\n\n  async function handleStatusChange(newStatus: 'confirmed' | 'cancelled' | 'completed') {\n    setUpdating(true)\n    await onStatusChange(newStatus)\n    setUpdating(false)\n  }\n\n  return (\n    <div className=\"rounded-2xl border border-stone-200 bg-white p-4 shadow-sm\">\n      <div className=\"flex gap-4\">\n        {isSelectionMode && (\n          <div className=\"flex shrink-0 items-start pt-0.5\">\n            <Checkbox\n              id={`select-${reservation.id}`}\n              checked={selected}\n              onCheckedChange={onSelectChange}\n              aria-label={`${reservation.products.title} 예약 선택`}\n            />\n          </div>\n        )}\n        <div className=\"h-20 w-20 shrink-0 overflow-hidden rounded-xl bg-stone-100\">\n          {reservation.products.image_url ? (\n            <img\n              src={reservation.products.image_url}\n              alt={reservation.products.title}\n              className=\"h-full w-full object-cover\"\n            />\n          ) : (\n            <div className=\"flex h-full items-center justify-center\">\n              <Package className=\"h-6 w-6 text-stone-300\" />\n            </div>\n          )}\n        </div>\n\n        <div className=\"flex flex-1 flex-col gap-2 min-w-0\">\n          <div className=\"flex items-center gap-2\">\n            <h3 className=\"text-sm font-semibold text-stone-900 truncate\">\n              {reservation.products.title}\n            </h3>\n            <span\n              className={`shrink-0 rounded-md px-2 py-0.5 text-[11px] font-medium border ${STATUS_STYLES[reservation.status]}`}\n            >\n              {STATUS_LABELS[reservation.status]}\n            </span>\n          </div>\n\n          <div className=\"space-y-1 text-xs text-stone-600\">\n            <p>\n              <span className=\"font-medium\">{reservation.customer_name}</span>\n              <span className=\"mx-2 text-stone-300\">·</span>\n              <span>{reservation.customer_phone}</span>\n            </p>\n            <p>\n              <span className=\"font-medium\">수량:</span> {reservation.quantity}개\n              <span className=\"mx-2 text-stone-300\">·</span>\n              <span className=\"font-medium\">금액:</span> {formatKoreanWon(reservation.products.price * reservation.quantity)}\n            </p>\n            {reservation.pickup_date && (\n              <p>\n                <span className=\"font-medium\">픽업일:</span> {formatDate(reservation.pickup_date)}\n              </p>\n            )}\n            {reservation.memo && (\n              <p className=\"text-stone-500\">\n                <span className=\"font-medium\">메모:</span> {reservation.memo}\n              </p>\n            )}\n            <p className=\"text-stone-400\">\n              예약일시: {formatDateTime(reservation.created_at)}\n            </p>\n          </div>\n\n          {reservation.status === 'pending' && (\n            <div className=\"flex gap-2 mt-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"h-8 text-xs border-green-200 text-green-700 hover:bg-green-50\"\n                onClick={() => handleStatusChange('confirmed')}\n                disabled={updating}\n              >\n                확인\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"h-8 text-xs border-red-200 text-red-700 hover:bg-red-50\"\n                onClick={() => handleStatusChange('cancelled')}\n                disabled={updating}\n              >\n                취소\n              </Button>\n            </div>\n          )}\n\n          {reservation.status === 'confirmed' && (\n            <div className=\"flex gap-2 mt-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"h-8 text-xs\"\n                onClick={() => handleStatusChange('completed')}\n                disabled={updating}\n              >\n                완료 처리\n              </Button>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  )\n}\n"
        }
    ]
}