{
    "sourceFile": "app/admin/products/actions.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1770978593395,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770982677447,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,19 +51,23 @@\n     image_url = publicUrl\n   }\n \n   const maxQuantityRaw = formData.get('maxQuantity') as string\n+  const maxPerCustomerRaw = formData.get('maxQuantityPerCustomer') as string\n   const deadlineRaw = formData.get('deadline') as string\n   const maxQtyNum = maxQuantityRaw ? parseInt(maxQuantityRaw, 10) : NaN\n   const max_quantity = Number.isNaN(maxQtyNum) || maxQtyNum <= 0 ? null : maxQtyNum\n+  const perCustomerNum = maxPerCustomerRaw ? parseInt(maxPerCustomerRaw, 10) : NaN\n+  const max_quantity_per_customer = Number.isNaN(perCustomerNum) || perCustomerNum < 1 ? null : perCustomerNum\n \n   const { error } = await supabase.from('products').insert({\n     shop_id: shop.id,\n     title: title.trim(),\n     description: (formData.get('description') as string) || null,\n     price,\n     image_url,\n     max_quantity,\n+    max_quantity_per_customer,\n     deadline: deadlineRaw || null,\n     is_active: true,\n   })\n \n@@ -140,8 +144,11 @@\n \n     image_url = publicUrl\n   }\n \n+  const maxPerCustomerRaw = formData.get('maxQuantityPerCustomer') as string\n+  const perCustomerNum = maxPerCustomerRaw ? parseInt(maxPerCustomerRaw, 10) : NaN\n+  const max_quantity_per_customer = Number.isNaN(perCustomerNum) || perCustomerNum < 1 ? null : perCustomerNum\n   const deadlineRaw = formData.get('deadline') as string\n \n   const { error } = await supabase\n     .from('products')\n@@ -150,8 +157,9 @@\n       description: (formData.get('description') as string) || null,\n       price,\n       image_url,\n       max_quantity: newMaxQuantity,\n+      max_quantity_per_customer,\n       deadline: deadlineRaw || null,\n     })\n     .eq('id', productId)\n \n@@ -182,4 +190,30 @@\n \n   if (error) throw error\n   revalidatePath('/admin/products')\n }\n+\n+export async function deleteProducts(productIds: string[]) {\n+  if (!productIds.length) return { error: '삭제할 상품을 선택해주세요' }\n+\n+  const supabase = await createClient()\n+  const { data: { user } } = await supabase.auth.getUser()\n+  if (!user) throw new Error('인증이 필요합니다')\n+\n+  const { data: shop } = await supabase\n+    .from('shops')\n+    .select('id')\n+    .eq('owner_id', user.id)\n+    .single()\n+\n+  if (!shop) throw new Error('가게를 찾을 수 없습니다')\n+\n+  const { error } = await supabase\n+    .from('products')\n+    .delete()\n+    .eq('shop_id', shop.id)\n+    .in('id', productIds)\n+\n+  if (error) return { error: '삭제에 실패했습니다' }\n+  revalidatePath('/admin/products')\n+  return { success: true }\n+}\n"
                },
                {
                    "date": 1770984712521,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -26,8 +26,11 @@\n   }\n   if (!price || price <= 0) {\n     return { error: '가격은 0원보다 커야 합니다' }\n   }\n+  if (price > 10_000_000) {\n+    return { error: '상품 금액은 1,000만원을 초과할 수 없습니다' }\n+  }\n \n   let image_url: string | null = null\n   const imageFile = formData.get('image') as File | null\n   if (imageFile && imageFile.size > 0) {\n@@ -110,8 +113,11 @@\n   }\n   if (!price || price <= 0) {\n     return { error: '가격은 0원보다 커야 합니다' }\n   }\n+  if (price > 10_000_000) {\n+    return { error: '상품 금액은 1,000만원을 초과할 수 없습니다' }\n+  }\n \n   const maxQuantityRaw = formData.get('maxQuantity') as string\n   const maxQtyNum = maxQuantityRaw ? parseInt(maxQuantityRaw, 10) : NaN\n   const newMaxQuantity = Number.isNaN(maxQtyNum) || maxQtyNum <= 0 ? null : maxQtyNum\n"
                }
            ],
            "date": 1770978593395,
            "name": "Commit-0",
            "content": "'use server'\n\nimport { revalidatePath } from 'next/cache'\nimport { redirect } from 'next/navigation'\nimport { createClient } from '@/lib/supabase/server'\nimport { sendPushToShop } from '@/lib/push'\n\nexport async function createProduct(formData: FormData) {\n  const supabase = await createClient()\n  const { data: { user } } = await supabase.auth.getUser()\n  if (!user) throw new Error('인증이 필요합니다')\n\n  const { data: shop } = await supabase\n    .from('shops')\n    .select('id, name, slug')\n    .eq('owner_id', user.id)\n    .single()\n\n  if (!shop) throw new Error('가게를 먼저 등록해주세요')\n\n  const title = formData.get('title') as string\n  const price = parseInt(formData.get('price') as string)\n\n  if (!title || title.trim().length === 0) {\n    return { error: '상품명을 입력해주세요' }\n  }\n  if (!price || price <= 0) {\n    return { error: '가격은 0원보다 커야 합니다' }\n  }\n\n  let image_url: string | null = null\n  const imageFile = formData.get('image') as File | null\n  if (imageFile && imageFile.size > 0) {\n    if (imageFile.size > 5 * 1024 * 1024) {\n      return { error: '이미지는 5MB 이하만 가능합니다' }\n    }\n    const fileExt = imageFile.name.split('.').pop()\n    const fileName = `${shop.id}-${Date.now()}.${fileExt}`\n    const { error: uploadError } = await supabase.storage\n      .from('product-images')\n      .upload(fileName, imageFile)\n\n    if (uploadError) {\n      return { error: `이미지 업로드에 실패했습니다: ${uploadError.message}` }\n    }\n\n    const { data: { publicUrl } } = supabase.storage\n      .from('product-images')\n      .getPublicUrl(fileName)\n\n    image_url = publicUrl\n  }\n\n  const maxQuantityRaw = formData.get('maxQuantity') as string\n  const deadlineRaw = formData.get('deadline') as string\n  const maxQtyNum = maxQuantityRaw ? parseInt(maxQuantityRaw, 10) : NaN\n  const max_quantity = Number.isNaN(maxQtyNum) || maxQtyNum <= 0 ? null : maxQtyNum\n\n  const { error } = await supabase.from('products').insert({\n    shop_id: shop.id,\n    title: title.trim(),\n    description: (formData.get('description') as string) || null,\n    price,\n    image_url,\n    max_quantity,\n    deadline: deadlineRaw || null,\n    is_active: true,\n  })\n\n  if (error) return { error: '상품 등록에 실패했습니다' }\n\n  try {\n    await sendPushToShop(shop.id, {\n      title: `${shop.name} 새 상품`,\n      body: `${title.trim()} - 지금 예약하세요!`,\n      url: `/${shop.slug}`,\n    })\n  } catch (error) {\n    console.error('Push notification failed:', error)\n  }\n\n  revalidatePath('/admin/products')\n  redirect('/admin/products')\n}\n\nexport async function updateProduct(productId: string, formData: FormData) {\n  const supabase = await createClient()\n  const { data: { user } } = await supabase.auth.getUser()\n  if (!user) throw new Error('인증이 필요합니다')\n\n  const { data: product } = await supabase\n    .from('products')\n    .select('*, shops!inner(owner_id)')\n    .eq('id', productId)\n    .single()\n\n  if (!product || (product.shops as { owner_id: string }).owner_id !== user.id) {\n    throw new Error('권한이 없습니다')\n  }\n\n  const title = formData.get('title') as string\n  const price = parseInt(formData.get('price') as string)\n\n  if (!title || title.trim().length === 0) {\n    return { error: '상품명을 입력해주세요' }\n  }\n  if (!price || price <= 0) {\n    return { error: '가격은 0원보다 커야 합니다' }\n  }\n\n  const maxQuantityRaw = formData.get('maxQuantity') as string\n  const maxQtyNum = maxQuantityRaw ? parseInt(maxQuantityRaw, 10) : NaN\n  const newMaxQuantity = Number.isNaN(maxQtyNum) || maxQtyNum <= 0 ? null : maxQtyNum\n\n  if (newMaxQuantity !== null && product.reserved_count > newMaxQuantity) {\n    return {\n      error: `이미 ${product.reserved_count}건 예약되어 있어 수량을 ${newMaxQuantity}로 줄일 수 없습니다`,\n    }\n  }\n\n  let image_url = product.image_url\n  const imageFile = formData.get('image') as File | null\n  if (imageFile && imageFile.size > 0) {\n    if (imageFile.size > 5 * 1024 * 1024) {\n      return { error: '이미지는 5MB 이하만 가능합니다' }\n    }\n    const fileExt = imageFile.name.split('.').pop()\n    const fileName = `${product.shop_id}-${Date.now()}.${fileExt}`\n    const { error: uploadError } = await supabase.storage\n      .from('product-images')\n      .upload(fileName, imageFile)\n\n    if (uploadError) {\n      return { error: `이미지 업로드에 실패했습니다: ${uploadError.message}` }\n    }\n\n    const { data: { publicUrl } } = supabase.storage\n      .from('product-images')\n      .getPublicUrl(fileName)\n\n    image_url = publicUrl\n  }\n\n  const deadlineRaw = formData.get('deadline') as string\n\n  const { error } = await supabase\n    .from('products')\n    .update({\n      title: title.trim(),\n      description: (formData.get('description') as string) || null,\n      price,\n      image_url,\n      max_quantity: newMaxQuantity,\n      deadline: deadlineRaw || null,\n    })\n    .eq('id', productId)\n\n  if (error) return { error: '상품 수정에 실패했습니다' }\n\n  revalidatePath('/admin/products')\n  redirect('/admin/products')\n}\n\nexport async function toggleProductActive(productId: string, isActive: boolean) {\n  const supabase = await createClient()\n  const { data: { user } } = await supabase.auth.getUser()\n  if (!user) throw new Error('인증이 필요합니다')\n\n  const { data: shop } = await supabase\n    .from('shops')\n    .select('id')\n    .eq('owner_id', user.id)\n    .single()\n\n  if (!shop) throw new Error('가게를 찾을 수 없습니다')\n\n  const { error } = await supabase\n    .from('products')\n    .update({ is_active: isActive })\n    .eq('id', productId)\n    .eq('shop_id', shop.id)\n\n  if (error) throw error\n  revalidatePath('/admin/products')\n}\n"
        }
    ]
}