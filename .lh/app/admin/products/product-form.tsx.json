{
    "sourceFile": "app/admin/products/product-form.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1770978593446,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770978775285,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -110,9 +110,15 @@\n             {error}\n           </div>\n         )}\n \n-        <form action={handleSubmit} method=\"post\" encType=\"multipart/form-data\" className=\"space-y-5\">\n+        <form\n+          action={handleSubmit}\n+          method=\"post\"\n+          encType=\"multipart/form-data\"\n+          className=\"space-y-5\"\n+          suppressHydrationWarning\n+        >\n           <div className=\"rounded-2xl border border-stone-200 bg-white p-5 shadow-sm space-y-5\">\n             <div className=\"space-y-2\">\n               <Label htmlFor=\"title\" className=\"text-stone-700\">\n                 상품명 <span className=\"text-red-500\">*</span>\n"
                },
                {
                    "date": 1770978806739,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -110,15 +110,9 @@\n             {error}\n           </div>\n         )}\n \n-        <form\n-          action={handleSubmit}\n-          method=\"post\"\n-          encType=\"multipart/form-data\"\n-          className=\"space-y-5\"\n-          suppressHydrationWarning\n-        >\n+        <form action={handleSubmit} className=\"space-y-5\">\n           <div className=\"rounded-2xl border border-stone-200 bg-white p-5 shadow-sm space-y-5\">\n             <div className=\"space-y-2\">\n               <Label htmlFor=\"title\" className=\"text-stone-700\">\n                 상품명 <span className=\"text-red-500\">*</span>\n"
                },
                {
                    "date": 1770982677453,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,8 +16,9 @@\n   description: string | null\n   price: number\n   image_url: string | null\n   max_quantity: number | null\n+  max_quantity_per_customer?: number | null\n   reserved_count: number\n   deadline: string | null\n }\n \n@@ -175,8 +176,24 @@\n                     현재 {product.reserved_count}건 예약됨 — 이 이하로 줄일 수 없습니다\n                   </p>\n                 )}\n               </div>\n+\n+              <div className=\"space-y-2\">\n+                <Label htmlFor=\"maxQuantityPerCustomer\" className=\"text-stone-700\">\n+                  1인당 구매 수량\n+                </Label>\n+                <Input\n+                  id=\"maxQuantityPerCustomer\"\n+                  name=\"maxQuantityPerCustomer\"\n+                  type=\"number\"\n+                  min={1}\n+                  defaultValue={product?.max_quantity_per_customer ?? ''}\n+                  placeholder=\"비워두면 제한 없음\"\n+                  className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400\"\n+                />\n+                <p className=\"text-xs text-stone-400\">같은 전화번호로 예약 시 1인당 최대 수량</p>\n+              </div>\n             </div>\n \n             <div className=\"space-y-2\">\n               <Label htmlFor=\"deadline\" className=\"text-stone-700\">\n"
                },
                {
                    "date": 1770982858903,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -78,9 +78,13 @@\n       if (result?.error) {\n         setError(result.error)\n         toast.error(result.error)\n       }\n-    } catch {\n+    } catch (e: unknown) {\n+      // redirect()가 던지는 예외는 그대로 전파 (성공 후 페이지 이동)\n+      if (e && typeof e === 'object' && 'digest' in e && String((e as { digest?: string }).digest).startsWith('NEXT_REDIRECT')) {\n+        throw e\n+      }\n       toast.error('처리 중 오류가 발생했습니다')\n     } finally {\n       setLoading(false)\n     }\n"
                }
            ],
            "date": 1770978593446,
            "name": "Commit-0",
            "content": "'use client'\n\nimport { useState, useRef } from 'react'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Textarea } from '@/components/ui/textarea'\nimport { ImagePlus, Loader2, ArrowLeft } from 'lucide-react'\nimport Link from 'next/link'\nimport toast, { Toaster } from 'react-hot-toast'\nimport { formatKoreanWon } from '@/lib/utils'\n\ninterface Product {\n  id: string\n  title: string\n  description: string | null\n  price: number\n  image_url: string | null\n  max_quantity: number | null\n  reserved_count: number\n  deadline: string | null\n}\n\ninterface ProductFormProps {\n  product?: Product\n  action: (formData: FormData) => Promise<{ error?: string } | undefined>\n  submitLabel: string\n}\n\nexport function ProductForm({ product, action, submitLabel }: ProductFormProps) {\n  const [loading, setLoading] = useState(false)\n  const [previewUrl, setPreviewUrl] = useState<string | null>(product?.image_url ?? null)\n  const [priceDisplay, setPriceDisplay] = useState(product?.price ? formatKoreanWon(product.price) : '')\n  const [error, setError] = useState<string | null>(null)\n  const fileInputRef = useRef<HTMLInputElement>(null)\n\n  function handleFileChange(e: React.ChangeEvent<HTMLInputElement>) {\n    const file = e.target.files?.[0]\n    if (file) {\n      if (file.size > 5 * 1024 * 1024) {\n        toast.error('이미지는 5MB 이하만 가능합니다')\n        e.target.value = ''\n        return\n      }\n      setPreviewUrl(URL.createObjectURL(file))\n    }\n  }\n\n  function handlePriceChange(e: React.ChangeEvent<HTMLInputElement>) {\n    const raw = e.target.value.replace(/[^0-9]/g, '')\n    if (raw) {\n      setPriceDisplay(formatKoreanWon(parseInt(raw)))\n    } else {\n      setPriceDisplay('')\n    }\n  }\n\n  function getPriceRawValue(): string {\n    return priceDisplay.replace(/[^0-9]/g, '')\n  }\n\n  function formatDeadlineForInput(deadline: string | null): string {\n    if (!deadline) return ''\n    const d = new Date(deadline)\n    const pad = (n: number) => n.toString().padStart(2, '0')\n    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`\n  }\n\n  async function handleSubmit(formData: FormData) {\n    setLoading(true)\n    setError(null)\n\n    formData.set('price', getPriceRawValue())\n\n    try {\n      const result = await action(formData)\n      if (result?.error) {\n        setError(result.error)\n        toast.error(result.error)\n      }\n    } catch {\n      toast.error('처리 중 오류가 발생했습니다')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <>\n      <Toaster\n        position=\"top-center\"\n        toastOptions={{ className: 'text-sm font-medium', duration: 3000 }}\n      />\n\n      <div className=\"space-y-5\">\n        <div className=\"flex items-center gap-3\">\n          <Link\n            href=\"/admin/products\"\n            className=\"flex h-8 w-8 items-center justify-center rounded-lg border border-stone-200 bg-white text-stone-500 hover:bg-stone-50 hover:text-stone-700 transition-colors\"\n          >\n            <ArrowLeft className=\"h-4 w-4\" />\n          </Link>\n          <h1 className=\"text-xl font-bold text-stone-900\">\n            {product ? '상품 수정' : '새 상품 등록'}\n          </h1>\n        </div>\n\n        {error && (\n          <div className=\"rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700\">\n            {error}\n          </div>\n        )}\n\n        <form action={handleSubmit} method=\"post\" encType=\"multipart/form-data\" className=\"space-y-5\">\n          <div className=\"rounded-2xl border border-stone-200 bg-white p-5 shadow-sm space-y-5\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"title\" className=\"text-stone-700\">\n                상품명 <span className=\"text-red-500\">*</span>\n              </Label>\n              <Input\n                id=\"title\"\n                name=\"title\"\n                defaultValue={product?.title ?? ''}\n                required\n                placeholder=\"예: 설 명절 한우 세트\"\n                className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\" className=\"text-stone-700\">\n                설명\n              </Label>\n              <Textarea\n                id=\"description\"\n                name=\"description\"\n                defaultValue={product?.description ?? ''}\n                placeholder=\"상품에 대한 설명을 입력하세요\"\n                rows={3}\n                className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400 resize-none\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-1 gap-5 sm:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"priceDisplay\" className=\"text-stone-700\">\n                  가격 <span className=\"text-red-500\">*</span>\n                </Label>\n                <Input\n                  id=\"priceDisplay\"\n                  value={priceDisplay}\n                  onChange={handlePriceChange}\n                  placeholder=\"₩0\"\n                  inputMode=\"numeric\"\n                  className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400\"\n                />\n                <input type=\"hidden\" name=\"price\" value={getPriceRawValue()} />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"maxQuantity\" className=\"text-stone-700\">\n                  최대 수량\n                </Label>\n                <Input\n                  id=\"maxQuantity\"\n                  name=\"maxQuantity\"\n                  type=\"number\"\n                  min={product?.reserved_count ?? 0}\n                  defaultValue={product?.max_quantity ?? ''}\n                  placeholder=\"비워두면 무제한\"\n                  className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400\"\n                />\n                {product && product.reserved_count > 0 && (\n                  <p className=\"text-xs text-amber-600\">\n                    현재 {product.reserved_count}건 예약됨 — 이 이하로 줄일 수 없습니다\n                  </p>\n                )}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"deadline\" className=\"text-stone-700\">\n                예약 마감일\n              </Label>\n              <Input\n                id=\"deadline\"\n                name=\"deadline\"\n                type=\"datetime-local\"\n                defaultValue={formatDeadlineForInput(product?.deadline ?? null)}\n                className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label className=\"text-stone-700\">상품 이미지</Label>\n              <div className=\"flex items-center gap-4\">\n                <button\n                  type=\"button\"\n                  onClick={() => fileInputRef.current?.click()}\n                  className=\"flex h-24 w-24 shrink-0 items-center justify-center rounded-xl border-2 border-dashed border-stone-200 bg-stone-50 hover:border-stone-300 hover:bg-stone-100 transition-colors overflow-hidden\"\n                >\n                  {previewUrl ? (\n                    <img\n                      src={previewUrl}\n                      alt=\"상품 이미지 미리보기\"\n                      className=\"h-full w-full object-cover\"\n                    />\n                  ) : (\n                    <ImagePlus className=\"h-6 w-6 text-stone-400\" />\n                  )}\n                </button>\n                <div className=\"text-xs text-stone-400\">\n                  <p>클릭하여 이미지를 업로드하세요</p>\n                  <p>JPG, PNG (최대 5MB)</p>\n                </div>\n              </div>\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                name=\"image\"\n                accept=\"image/*\"\n                onChange={handleFileChange}\n                className=\"hidden\"\n              />\n            </div>\n          </div>\n\n          <div className=\"flex gap-3\">\n            <Button\n              type=\"submit\"\n              disabled={loading}\n              className=\"h-11 bg-stone-900 text-white hover:bg-stone-800 transition-colors px-8\"\n            >\n              {loading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  처리 중...\n                </>\n              ) : (\n                submitLabel\n              )}\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              className=\"h-11\"\n              asChild\n            >\n              <Link href=\"/admin/products\">취소</Link>\n            </Button>\n          </div>\n        </form>\n      </div>\n    </>\n  )\n}\n"
        }
    ]
}