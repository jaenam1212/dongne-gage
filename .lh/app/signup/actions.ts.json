{
    "sourceFile": "app/signup/actions.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1770977385852,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770977476900,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n 'use server'\n \n import { redirect } from 'next/navigation'\n-import { createClient } from '@/lib/supabase/server'\n+import { createClient, createServiceRoleClient } from '@/lib/supabase/server'\n \n export async function signUp(formData: FormData) {\n   const email = formData.get('email') as string\n   const password = formData.get('password') as string\n@@ -46,10 +46,11 @@\n     }\n     return { error: msg }\n   }\n \n-  // Create shop\n-  const { error: shopError } = await supabase.from('shops').insert({\n+  // Create shop (가입 직후엔 쿠키에 세션이 없어 RLS가 막으므로 service role 사용)\n+  const admin = createServiceRoleClient()\n+  const { error: shopError } = await admin.from('shops').insert({\n     owner_id: authData.user.id,\n     slug,\n     name: shopName,\n     phone,\n"
                },
                {
                    "date": 1770977525987,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,8 +43,12 @@\n     const rateLimitMatch = msg.match(/after (\\d+) seconds?/i)\n     if (rateLimitMatch) {\n       return { error: `보안을 위해 ${rateLimitMatch[1]}초 후에 다시 시도해 주세요.` }\n     }\n+    // Supabase: \"email rate limit exceeded\" (가입/비밀번호재설정 등 이메일 요청 시간당 제한)\n+    if (/email rate limit|rate limit exceeded/i.test(msg)) {\n+      return { error: '이메일 발송 한도를 초과했습니다. 1시간 후에 다시 시도해 주세요.' }\n+    }\n     return { error: msg }\n   }\n \n   // Create shop (가입 직후엔 쿠키에 세션이 없어 RLS가 막으므로 service role 사용)\n"
                },
                {
                    "date": 1770977733212,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,43 +17,44 @@\n   if (password.length < 8) {\n     return { error: '비밀번호는 최소 8자 이상이어야 합니다' }\n   }\n \n-  const supabase = await createClient()\n+  const admin = createServiceRoleClient()\n \n-  // Check slug uniqueness\n-  const { data: existingShop } = await supabase\n+  // Slug 중복 검사 (RLS 없이 전체 조회)\n+  const { data: existingShop } = await admin\n     .from('shops')\n     .select('id')\n     .eq('slug', slug)\n-    .single()\n+    .maybeSingle()\n \n   if (existingShop) {\n     return { error: '이미 사용중인 주소입니다. 다른 주소를 입력해주세요.' }\n   }\n \n-  // Create auth user\n+  const supabase = await createClient()\n+\n+  // 가입 (이메일 확인 메일 없이 — 가입 후 Admin으로 확인 처리)\n   const { data: authData, error: authError } = await supabase.auth.signUp({\n     email,\n     password,\n   })\n \n   if (authError || !authData.user) {\n     const msg = authError?.message ?? '가입에 실패했습니다'\n-    // Supabase rate limit: \"For security purposes, you can only request this after 26 seconds\"\n     const rateLimitMatch = msg.match(/after (\\d+) seconds?/i)\n     if (rateLimitMatch) {\n       return { error: `보안을 위해 ${rateLimitMatch[1]}초 후에 다시 시도해 주세요.` }\n     }\n-    // Supabase: \"email rate limit exceeded\" (가입/비밀번호재설정 등 이메일 요청 시간당 제한)\n     if (/email rate limit|rate limit exceeded/i.test(msg)) {\n       return { error: '이메일 발송 한도를 초과했습니다. 1시간 후에 다시 시도해 주세요.' }\n     }\n     return { error: msg }\n   }\n \n-  // Create shop (가입 직후엔 쿠키에 세션이 없어 RLS가 막으므로 service role 사용)\n-  const admin = createServiceRoleClient()\n+  // 이메일 확인 없이 바로 사용 가능하도록 Admin API로 확인 처리 (확인 메일 미발송)\n+  await admin.auth.admin.updateUserById(authData.user.id, { email_confirm: true })\n+\n   const { error: shopError } = await admin.from('shops').insert({\n     owner_id: authData.user.id,\n     slug,\n     name: shopName,\n@@ -61,9 +62,9 @@\n     is_active: true,\n   })\n \n   if (shopError) {\n-    return { error: '가게 생성에 실패했습니다' }\n+    return { error: `가게 생성에 실패했습니다: ${shopError.message}` }\n   }\n \n   redirect('/admin/dashboard')\n }\n"
                },
                {
                    "date": 1770977888325,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,31 +30,23 @@\n   if (existingShop) {\n     return { error: '이미 사용중인 주소입니다. 다른 주소를 입력해주세요.' }\n   }\n \n-  const supabase = await createClient()\n-\n-  // 가입 (이메일 확인 메일 없이 — 가입 후 Admin으로 확인 처리)\n-  const { data: authData, error: authError } = await supabase.auth.signUp({\n+  // Admin API로 유저 생성 — 이메일 발송 없음 (rate limit 회피)\n+  const { data: authData, error: authError } = await admin.auth.admin.createUser({\n     email,\n     password,\n+    email_confirm: true,\n   })\n \n   if (authError || !authData.user) {\n     const msg = authError?.message ?? '가입에 실패했습니다'\n-    const rateLimitMatch = msg.match(/after (\\d+) seconds?/i)\n-    if (rateLimitMatch) {\n-      return { error: `보안을 위해 ${rateLimitMatch[1]}초 후에 다시 시도해 주세요.` }\n+    if (/already registered|already exists|duplicate/i.test(msg)) {\n+      return { error: '이미 가입된 이메일입니다. 로그인해 주세요.' }\n     }\n-    if (/email rate limit|rate limit exceeded/i.test(msg)) {\n-      return { error: '이메일 발송 한도를 초과했습니다. 1시간 후에 다시 시도해 주세요.' }\n-    }\n     return { error: msg }\n   }\n \n-  // 이메일 확인 없이 바로 사용 가능하도록 Admin API로 확인 처리 (확인 메일 미발송)\n-  await admin.auth.admin.updateUserById(authData.user.id, { email_confirm: true })\n-\n   const { error: shopError } = await admin.from('shops').insert({\n     owner_id: authData.user.id,\n     slug,\n     name: shopName,\n@@ -65,6 +57,10 @@\n   if (shopError) {\n     return { error: `가게 생성에 실패했습니다: ${shopError.message}` }\n   }\n \n+  // 세션 쿠키 설정 (바로 로그인된 상태로)\n+  const supabase = await createClient()\n+  await supabase.auth.signInWithPassword({ email, password })\n+\n   redirect('/admin/dashboard')\n }\n"
                },
                {
                    "date": 1770978110447,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,23 +30,33 @@\n   if (existingShop) {\n     return { error: '이미 사용중인 주소입니다. 다른 주소를 입력해주세요.' }\n   }\n \n-  // Admin API로 유저 생성 — 이메일 발송 없음 (rate limit 회피)\n-  const { data: authData, error: authError } = await admin.auth.admin.createUser({\n+  const supabase = await createClient()\n+\n+  // signUp 사용. 이메일 한도 방지: Supabase 대시보드 → Authentication → Providers → Email → \"Confirm email\" 끄기\n+  const { data: authData, error: authError } = await supabase.auth.signUp({\n     email,\n     password,\n-    email_confirm: true,\n   })\n \n   if (authError || !authData.user) {\n     const msg = authError?.message ?? '가입에 실패했습니다'\n+    if (/email rate limit|rate limit exceeded/i.test(msg)) {\n+      return {\n+        error:\n+          '이메일 발송 한도 초과입니다. Supabase 대시보드에서 Authentication → Providers → Email → \"Confirm email\"을 끄고, 1시간 후 다시 시도해 주세요.',\n+      }\n+    }\n     if (/already registered|already exists|duplicate/i.test(msg)) {\n       return { error: '이미 가입된 이메일입니다. 로그인해 주세요.' }\n     }\n     return { error: msg }\n   }\n \n+  // 가입 직후 쿠키에 세션 없어 RLS 통과 위해 확인 처리\n+  await admin.auth.admin.updateUserById(authData.user.id, { email_confirm: true })\n+\n   const { error: shopError } = await admin.from('shops').insert({\n     owner_id: authData.user.id,\n     slug,\n     name: shopName,\n@@ -57,10 +67,8 @@\n   if (shopError) {\n     return { error: `가게 생성에 실패했습니다: ${shopError.message}` }\n   }\n \n-  // 세션 쿠키 설정 (바로 로그인된 상태로)\n-  const supabase = await createClient()\n   await supabase.auth.signInWithPassword({ email, password })\n \n   redirect('/admin/dashboard')\n }\n"
                }
            ],
            "date": 1770977385852,
            "name": "Commit-0",
            "content": "'use server'\n\nimport { redirect } from 'next/navigation'\nimport { createClient } from '@/lib/supabase/server'\n\nexport async function signUp(formData: FormData) {\n  const email = formData.get('email') as string\n  const password = formData.get('password') as string\n  const shopName = (formData.get('shopName') as string).trim()\n  const slug = (formData.get('slug') as string).trim()\n  const phone = (formData.get('phone') as string)?.trim() || null\n\n  if (!email || !password || !shopName || !slug) {\n    return { error: '필수 항목을 입력해주세요' }\n  }\n\n  if (password.length < 8) {\n    return { error: '비밀번호는 최소 8자 이상이어야 합니다' }\n  }\n\n  const supabase = await createClient()\n\n  // Check slug uniqueness\n  const { data: existingShop } = await supabase\n    .from('shops')\n    .select('id')\n    .eq('slug', slug)\n    .single()\n\n  if (existingShop) {\n    return { error: '이미 사용중인 주소입니다. 다른 주소를 입력해주세요.' }\n  }\n\n  // Create auth user\n  const { data: authData, error: authError } = await supabase.auth.signUp({\n    email,\n    password,\n  })\n\n  if (authError || !authData.user) {\n    const msg = authError?.message ?? '가입에 실패했습니다'\n    // Supabase rate limit: \"For security purposes, you can only request this after 26 seconds\"\n    const rateLimitMatch = msg.match(/after (\\d+) seconds?/i)\n    if (rateLimitMatch) {\n      return { error: `보안을 위해 ${rateLimitMatch[1]}초 후에 다시 시도해 주세요.` }\n    }\n    return { error: msg }\n  }\n\n  // Create shop\n  const { error: shopError } = await supabase.from('shops').insert({\n    owner_id: authData.user.id,\n    slug,\n    name: shopName,\n    phone,\n    is_active: true,\n  })\n\n  if (shopError) {\n    return { error: '가게 생성에 실패했습니다' }\n  }\n\n  redirect('/admin/dashboard')\n}\n"
        }
    ]
}