{
    "sourceFile": "components/customer/reservation-form.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 7,
            "patches": [
                {
                    "date": 1770982677431,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770983023665,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -283,15 +283,14 @@\n               inputMode=\"numeric\"\n               className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400 h-11\"\n               aria-invalid={!!errors.quantity}\n             />\n-            {(remaining !== null || product.max_quantity_per_customer != null) && (\n-              <p className=\"text-xs text-stone-400\">\n-                {remaining !== null && `${remaining}개 남음`}\n-                {remaining !== null && product.max_quantity_per_customer != null && ' · '}\n-                {product.max_quantity_per_customer != null && `1인당 최대 ${product.max_quantity_per_customer}개`}\n-              </p>\n-            )}\n+            <p className=\"text-xs text-stone-400\">\n+              {remaining !== null ? `재고 ${remaining}개 남음` : '재고 무제한'}\n+              {product.max_quantity_per_customer != null && (\n+                <span className=\"block mt-0.5\">1인당 최대 {product.max_quantity_per_customer}개</span>\n+              )}\n+            </p>\n             {errors.quantity && (\n               <p className=\"text-xs text-red-500\">{errors.quantity}</p>\n             )}\n           </div>\n"
                },
                {
                    "date": 1770983150065,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,11 +34,12 @@\n function normalizePhone(phone: string): string {\n   return phone.replace(/-/g, '')\n }\n \n+/** 재고 남은 수. max_quantity만 사용 (1인당 제한과 혼동 금지) */\n function getRemainingQuantity(product: Product): number | null {\n-  if (product.max_quantity === null) return null\n-  return product.max_quantity - product.reserved_count\n+  if (product.max_quantity == null) return null\n+  return Number(product.max_quantity) - Number(product.reserved_count ?? 0)\n }\n \n export function ReservationForm({\n   product,\n"
                },
                {
                    "date": 1770983888164,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,8 +9,9 @@\n import { Checkbox } from '@/components/ui/checkbox'\n import { Loader2, CheckCircle2, Copy } from 'lucide-react'\n import { formatKoreanWon } from '@/lib/utils'\n import toast, { Toaster } from 'react-hot-toast'\n+import { saveOrderToMyOrders } from '@/lib/my-orders-storage'\n \n interface Product {\n   id: string\n   title: string\n@@ -43,11 +44,13 @@\n \n export function ReservationForm({\n   product,\n   shopSlug,\n+  shopName,\n }: {\n   product: Product\n   shopSlug: string\n+  shopName: string\n }) {\n   const router = useRouter()\n   const [loading, setLoading] = useState(false)\n   const [privacyAgreed, setPrivacyAgreed] = useState(false)\n@@ -122,9 +125,28 @@\n         toast.error(data.error || '예약에 실패했습니다')\n         return\n       }\n \n-      setResult(data.reservation)\n+      const reservation = data.reservation as ReservationResult & { status?: string }\n+      setResult(reservation)\n+\n+      try {\n+        saveOrderToMyOrders({\n+          id: reservation.id,\n+          shop_slug: shopSlug,\n+          shop_name: shopName,\n+          product_title: product.title,\n+          product_price: product.price,\n+          quantity: reservation.quantity,\n+          total_price: product.price * reservation.quantity,\n+          pickup_date: reservation.pickup_date ?? null,\n+          status: (reservation.status as 'pending' | 'confirmed' | 'cancelled' | 'completed') ?? 'pending',\n+          customer_name: reservation.customer_name,\n+          created_at: new Date().toISOString(),\n+        })\n+      } catch {\n+        // localStorage 실패 시 무시\n+      }\n     } catch {\n       toast.error('네트워크 오류가 발생했습니다')\n     } finally {\n       setLoading(false)\n@@ -196,14 +218,23 @@\n             </div>\n           </div>\n         </div>\n \n-        <Button\n-          onClick={() => router.push(`/${shopSlug}`)}\n-          className=\"w-full h-12 bg-stone-900 text-white hover:bg-stone-800 rounded-xl text-base font-semibold\"\n-        >\n-          가게로 돌아가기\n-        </Button>\n+        <div className=\"flex gap-2\">\n+          <Button\n+            variant=\"outline\"\n+            onClick={() => router.push('/my-orders')}\n+            className=\"flex-1 h-12 rounded-xl text-base font-semibold border-stone-200\"\n+          >\n+            내 주문 내역\n+          </Button>\n+          <Button\n+            onClick={() => router.push(`/${shopSlug}`)}\n+            className=\"flex-1 h-12 bg-stone-900 text-white hover:bg-stone-800 rounded-xl text-base font-semibold\"\n+          >\n+            가게로 돌아가기\n+          </Button>\n+        </div>\n       </div>\n     )\n   }\n \n"
                },
                {
                    "date": 1770985090542,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,12 +6,13 @@\n import { Input } from '@/components/ui/input'\n import { Label } from '@/components/ui/label'\n import { Textarea } from '@/components/ui/textarea'\n import { Checkbox } from '@/components/ui/checkbox'\n-import { Loader2, CheckCircle2, Copy } from 'lucide-react'\n+import { Loader2, CheckCircle2, Copy, Calendar } from 'lucide-react'\n import { formatKoreanWon } from '@/lib/utils'\n import toast, { Toaster } from 'react-hot-toast'\n import { saveOrderToMyOrders } from '@/lib/my-orders-storage'\n+import { getTodayKST } from '@/lib/datetime-kst'\n \n interface Product {\n   id: string\n   title: string\n@@ -221,9 +222,9 @@\n \n         <div className=\"flex gap-2\">\n           <Button\n             variant=\"outline\"\n-            onClick={() => router.push('/my-orders')}\n+            onClick={() => router.push(`/my-orders?returnTo=${encodeURIComponent(shopSlug)}`)}\n             className=\"flex-1 h-12 rounded-xl text-base font-semibold border-stone-200\"\n           >\n             내 주문 내역\n           </Button>\n@@ -330,15 +331,20 @@\n           <div className=\"space-y-2\">\n             <Label htmlFor=\"pickup_date\" className=\"text-stone-700\">\n               픽업 희망일\n             </Label>\n-            <Input\n-              id=\"pickup_date\"\n-              name=\"pickup_date\"\n-              type=\"date\"\n-              min={new Date().toISOString().split('T')[0]}\n-              className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400 h-11\"\n-            />\n+            <div className=\"relative\">\n+              <span className=\"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-stone-400\">\n+                <Calendar className=\"h-4 w-4\" />\n+              </span>\n+              <Input\n+                id=\"pickup_date\"\n+                name=\"pickup_date\"\n+                type=\"date\"\n+                min={getTodayKST()}\n+                className=\"h-11 border-stone-200 bg-stone-50 pl-10 focus-visible:ring-stone-400\"\n+              />\n+            </div>\n           </div>\n \n           <div className=\"space-y-2\">\n             <Label htmlFor=\"memo\" className=\"text-stone-700\">\n"
                },
                {
                    "date": 1770985166946,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n import { Input } from '@/components/ui/input'\n import { Label } from '@/components/ui/label'\n import { Textarea } from '@/components/ui/textarea'\n import { Checkbox } from '@/components/ui/checkbox'\n-import { Loader2, CheckCircle2, Copy, Calendar } from 'lucide-react'\n+import { Loader2, CheckCircle2, Copy } from 'lucide-react'\n import { formatKoreanWon } from '@/lib/utils'\n import toast, { Toaster } from 'react-hot-toast'\n import { saveOrderToMyOrders } from '@/lib/my-orders-storage'\n import { getTodayKST } from '@/lib/datetime-kst'\n@@ -331,20 +331,15 @@\n           <div className=\"space-y-2\">\n             <Label htmlFor=\"pickup_date\" className=\"text-stone-700\">\n               픽업 희망일\n             </Label>\n-            <div className=\"relative\">\n-              <span className=\"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-stone-400\">\n-                <Calendar className=\"h-4 w-4\" />\n-              </span>\n-              <Input\n-                id=\"pickup_date\"\n-                name=\"pickup_date\"\n-                type=\"date\"\n-                min={getTodayKST()}\n-                className=\"h-11 border-stone-200 bg-stone-50 pl-10 focus-visible:ring-stone-400\"\n-              />\n-            </div>\n+            <Input\n+              id=\"pickup_date\"\n+              name=\"pickup_date\"\n+              type=\"date\"\n+              min={getTodayKST()}\n+              className=\"h-11 border-stone-200 bg-stone-50 focus-visible:ring-stone-400\"\n+            />\n           </div>\n \n           <div className=\"space-y-2\">\n             <Label htmlFor=\"memo\" className=\"text-stone-700\">\n"
                },
                {
                    "date": 1770985534850,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,8 +11,9 @@\n import { formatKoreanWon } from '@/lib/utils'\n import toast, { Toaster } from 'react-hot-toast'\n import { saveOrderToMyOrders } from '@/lib/my-orders-storage'\n import { getTodayKST } from '@/lib/datetime-kst'\n+import { DatePicker } from '@/components/ui/date-picker'\n \n interface Product {\n   id: string\n   title: string\n"
                },
                {
                    "date": 1770985775088,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -332,14 +332,14 @@\n           <div className=\"space-y-2\">\n             <Label htmlFor=\"pickup_date\" className=\"text-stone-700\">\n               픽업 희망일\n             </Label>\n-            <Input\n-              id=\"pickup_date\"\n+            <DatePicker\n               name=\"pickup_date\"\n-              type=\"date\"\n               min={getTodayKST()}\n-              className=\"h-11 border-stone-200 bg-stone-50 focus-visible:ring-stone-400\"\n+              placeholder=\"날짜 선택\"\n+              className=\"w-full\"\n+              inputClassName=\"h-11\"\n             />\n           </div>\n \n           <div className=\"space-y-2\">\n"
                }
            ],
            "date": 1770982677431,
            "name": "Commit-0",
            "content": "'use client'\n\nimport { useState } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Checkbox } from '@/components/ui/checkbox'\nimport { Loader2, CheckCircle2, Copy } from 'lucide-react'\nimport { formatKoreanWon } from '@/lib/utils'\nimport toast, { Toaster } from 'react-hot-toast'\n\ninterface Product {\n  id: string\n  title: string\n  price: number\n  image_url: string | null\n  max_quantity: number | null\n  max_quantity_per_customer?: number | null\n  reserved_count: number\n  deadline: string | null\n}\n\ninterface ReservationResult {\n  id: string\n  customer_name: string\n  quantity: number\n  pickup_date: string | null\n}\n\nconst PHONE_REGEX = /^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$/\n\nfunction normalizePhone(phone: string): string {\n  return phone.replace(/-/g, '')\n}\n\nfunction getRemainingQuantity(product: Product): number | null {\n  if (product.max_quantity === null) return null\n  return product.max_quantity - product.reserved_count\n}\n\nexport function ReservationForm({\n  product,\n  shopSlug,\n}: {\n  product: Product\n  shopSlug: string\n}) {\n  const router = useRouter()\n  const [loading, setLoading] = useState(false)\n  const [privacyAgreed, setPrivacyAgreed] = useState(false)\n  const [showPrivacy, setShowPrivacy] = useState(false)\n  const [result, setResult] = useState<ReservationResult | null>(null)\n  const [errors, setErrors] = useState<Record<string, string>>({})\n\n  const remaining = getRemainingQuantity(product)\n  const perCustomer = product.max_quantity_per_customer ?? 99\n  const maxQty =\n    remaining !== null\n      ? Math.min(remaining, perCustomer, 99)\n      : Math.min(perCustomer, 99)\n\n  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {\n    e.preventDefault()\n    const form = new FormData(e.currentTarget)\n    const newErrors: Record<string, string> = {}\n\n    const name = (form.get('customer_name') as string)?.trim()\n    const phone = (form.get('customer_phone') as string)?.trim()\n    const quantity = parseInt(form.get('quantity') as string) || 0\n    const pickupDate = form.get('pickup_date') as string\n    const memo = form.get('memo') as string\n\n    if (!name) newErrors.customer_name = '이름을 입력해주세요'\n    if (!phone || !PHONE_REGEX.test(phone)) {\n      newErrors.customer_phone = '전화번호 형식이 올바르지 않습니다 (예: 010-1234-5678)'\n    }\n    if (quantity < 1) newErrors.quantity = '수량을 선택해주세요'\n    if (remaining !== null && quantity > remaining) {\n      newErrors.quantity = `재고 부족입니다. 최대 ${remaining}개까지 예약할 수 있습니다`\n    } else if (quantity > maxQty) {\n      newErrors.quantity =\n        product.max_quantity_per_customer != null\n          ? `1인당 최대 ${product.max_quantity_per_customer}개까지 예약할 수 있습니다`\n          : `최대 ${maxQty}개까지 예약할 수 있습니다`\n    }\n    if (!privacyAgreed) newErrors.privacy = '개인정보 동의가 필요합니다'\n\n    if (Object.keys(newErrors).length > 0) {\n      setErrors(newErrors)\n      return\n    }\n\n    setErrors({})\n    setLoading(true)\n\n    try {\n      const res = await fetch('/api/reservations', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          product_id: product.id,\n          customer_name: name,\n          customer_phone: normalizePhone(phone),\n          quantity,\n          pickup_date: pickupDate || null,\n          memo: memo?.trim() || null,\n          privacy_agreed: privacyAgreed,\n        }),\n      })\n\n      if (res.status === 429) {\n        toast.error('요청이 너무 많습니다. 잠시 후 다시 시도해주세요.')\n        return\n      }\n\n      const data = await res.json()\n\n      if (!res.ok) {\n        toast.error(data.error || '예약에 실패했습니다')\n        return\n      }\n\n      setResult(data.reservation)\n    } catch {\n      toast.error('네트워크 오류가 발생했습니다')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (result) {\n    return (\n      <div className=\"mx-auto max-w-md space-y-6 px-4 py-10 text-center\">\n        <Toaster position=\"top-center\" toastOptions={{ className: 'text-sm font-medium', duration: 3000 }} />\n\n        <div className=\"flex justify-center\">\n          <div className=\"flex h-16 w-16 items-center justify-center rounded-full bg-emerald-100\">\n            <CheckCircle2 className=\"h-8 w-8 text-emerald-600\" />\n          </div>\n        </div>\n\n        <div>\n          <h2 className=\"text-xl font-bold text-stone-900\">예약이 완료되었습니다</h2>\n          <p className=\"mt-1 text-sm text-stone-500\">아래 예약번호를 저장해주세요</p>\n        </div>\n\n        <div className=\"rounded-2xl border border-stone-200 bg-white p-5 shadow-sm space-y-4\">\n          <div>\n            <p className=\"text-xs text-stone-400\">예약번호</p>\n            <div className=\"mt-1 flex items-center justify-center gap-2\">\n              <code className=\"text-lg font-bold text-stone-900 tracking-wider\">\n                {result.id.slice(0, 8).toUpperCase()}\n              </code>\n              <button\n                type=\"button\"\n                onClick={() => {\n                  navigator.clipboard.writeText(result.id.slice(0, 8).toUpperCase())\n                  toast.success('복사되었습니다')\n                }}\n                className=\"rounded-lg p-1.5 text-stone-400 hover:bg-stone-100 hover:text-stone-600 transition-colors\"\n              >\n                <Copy className=\"h-4 w-4\" />\n              </button>\n            </div>\n          </div>\n\n          <div className=\"h-px bg-stone-100\" />\n\n          <div className=\"grid grid-cols-2 gap-3 text-sm\">\n            <div>\n              <p className=\"text-xs text-stone-400\">상품</p>\n              <p className=\"mt-0.5 font-medium text-stone-700\">{product.title}</p>\n            </div>\n            <div>\n              <p className=\"text-xs text-stone-400\">수량</p>\n              <p className=\"mt-0.5 font-medium text-stone-700\">{result.quantity}개</p>\n            </div>\n            <div>\n              <p className=\"text-xs text-stone-400\">예약자</p>\n              <p className=\"mt-0.5 font-medium text-stone-700\">{result.customer_name}</p>\n            </div>\n            {result.pickup_date && (\n              <div>\n                <p className=\"text-xs text-stone-400\">픽업일</p>\n                <p className=\"mt-0.5 font-medium text-stone-700\">{result.pickup_date}</p>\n              </div>\n            )}\n            <div>\n              <p className=\"text-xs text-stone-400\">금액</p>\n              <p className=\"mt-0.5 font-bold text-stone-900\">\n                {formatKoreanWon(product.price * result.quantity)}\n              </p>\n            </div>\n          </div>\n        </div>\n\n        <Button\n          onClick={() => router.push(`/${shopSlug}`)}\n          className=\"w-full h-12 bg-stone-900 text-white hover:bg-stone-800 rounded-xl text-base font-semibold\"\n        >\n          가게로 돌아가기\n        </Button>\n      </div>\n    )\n  }\n\n  return (\n    <>\n      <Toaster position=\"top-center\" toastOptions={{ className: 'text-sm font-medium', duration: 3000 }} />\n\n      <form onSubmit={handleSubmit} className=\"space-y-5\">\n        <div className=\"rounded-2xl border border-stone-200 bg-white p-5 shadow-sm\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"h-16 w-16 shrink-0 overflow-hidden rounded-xl bg-stone-100\">\n              {product.image_url ? (\n                <img src={product.image_url} alt={product.title} className=\"h-full w-full object-cover\" />\n              ) : (\n                <div className=\"flex h-full items-center justify-center\">\n                  <div className=\"h-6 w-6 rounded bg-stone-200\" />\n                </div>\n              )}\n            </div>\n            <div>\n              <h3 className=\"font-bold text-stone-900\">{product.title}</h3>\n              <p className=\"text-lg font-extrabold text-stone-900 tracking-tight\">\n                {formatKoreanWon(product.price)}\n              </p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"rounded-2xl border border-stone-200 bg-white p-5 shadow-sm space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"customer_name\" className=\"text-stone-700\">\n              이름 <span className=\"text-red-500\">*</span>\n            </Label>\n            <Input\n              id=\"customer_name\"\n              name=\"customer_name\"\n              placeholder=\"예약자 이름\"\n              required\n              className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400 h-11\"\n              aria-invalid={!!errors.customer_name}\n            />\n            {errors.customer_name && (\n              <p className=\"text-xs text-red-500\">{errors.customer_name}</p>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"customer_phone\" className=\"text-stone-700\">\n              전화번호 <span className=\"text-red-500\">*</span>\n            </Label>\n            <Input\n              id=\"customer_phone\"\n              name=\"customer_phone\"\n              type=\"tel\"\n              placeholder=\"010-1234-5678\"\n              required\n              inputMode=\"tel\"\n              className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400 h-11\"\n              aria-invalid={!!errors.customer_phone}\n            />\n            {errors.customer_phone && (\n              <p className=\"text-xs text-red-500\">{errors.customer_phone}</p>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"quantity\" className=\"text-stone-700\">\n              수량 <span className=\"text-red-500\">*</span>\n            </Label>\n            <Input\n              id=\"quantity\"\n              name=\"quantity\"\n              type=\"number\"\n              min={1}\n              max={maxQty}\n              defaultValue={1}\n              required\n              inputMode=\"numeric\"\n              className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400 h-11\"\n              aria-invalid={!!errors.quantity}\n            />\n            {(remaining !== null || product.max_quantity_per_customer != null) && (\n              <p className=\"text-xs text-stone-400\">\n                {remaining !== null && `${remaining}개 남음`}\n                {remaining !== null && product.max_quantity_per_customer != null && ' · '}\n                {product.max_quantity_per_customer != null && `1인당 최대 ${product.max_quantity_per_customer}개`}\n              </p>\n            )}\n            {errors.quantity && (\n              <p className=\"text-xs text-red-500\">{errors.quantity}</p>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"pickup_date\" className=\"text-stone-700\">\n              픽업 희망일\n            </Label>\n            <Input\n              id=\"pickup_date\"\n              name=\"pickup_date\"\n              type=\"date\"\n              min={new Date().toISOString().split('T')[0]}\n              className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400 h-11\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"memo\" className=\"text-stone-700\">\n              메모\n            </Label>\n            <Textarea\n              id=\"memo\"\n              name=\"memo\"\n              placeholder=\"요청 사항이 있으면 적어주세요\"\n              rows={2}\n              className=\"border-stone-200 bg-stone-50 focus-visible:ring-stone-400 resize-none\"\n            />\n          </div>\n        </div>\n\n        <div className=\"rounded-2xl border border-stone-200 bg-white p-5 shadow-sm space-y-3\">\n          <div className=\"flex items-start gap-3\">\n            <Checkbox\n              id=\"privacy\"\n              checked={privacyAgreed}\n              onCheckedChange={(checked) => setPrivacyAgreed(checked === true)}\n              className=\"mt-0.5\"\n            />\n            <div>\n              <Label htmlFor=\"privacy\" className=\"text-sm text-stone-700 cursor-pointer\">\n                개인정보 수집 및 이용에 동의합니다{' '}\n                <span className=\"text-red-500\">(필수)</span>\n              </Label>\n              <button\n                type=\"button\"\n                onClick={() => setShowPrivacy(!showPrivacy)}\n                className=\"mt-1 block text-xs text-stone-400 underline underline-offset-2 hover:text-stone-600 transition-colors\"\n              >\n                {showPrivacy ? '닫기' : '자세히 보기'}\n              </button>\n            </div>\n          </div>\n\n          {showPrivacy && (\n            <div className=\"rounded-xl bg-stone-50 p-4 text-xs text-stone-500 leading-relaxed space-y-1\">\n              <p>• 수집 항목: 이름, 전화번호</p>\n              <p>• 목적: 예약 관리</p>\n              <p>• 보유 기간: 예약 완료 후 1년</p>\n            </div>\n          )}\n\n          {errors.privacy && (\n            <p className=\"text-xs text-red-500\">{errors.privacy}</p>\n          )}\n        </div>\n\n        <Button\n          type=\"submit\"\n          disabled={loading}\n          className=\"w-full h-12 bg-stone-900 text-white hover:bg-stone-800 rounded-xl text-base font-semibold min-h-[44px]\"\n        >\n          {loading ? (\n            <>\n              <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n              예약 처리 중...\n            </>\n          ) : (\n            '예약하기'\n          )}\n        </Button>\n      </form>\n    </>\n  )\n}\n"
        }
    ]
}