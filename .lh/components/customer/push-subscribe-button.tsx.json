{
    "sourceFile": "components/customer/push-subscribe-button.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1770982396939,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770984382805,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,13 +7,13 @@\n import toast from 'react-hot-toast'\n \n const VAPID_PUBLIC_KEY = process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY\n \n-function urlBase64ToUint8Array(base64String: string): Uint8Array {\n+function urlBase64ToUint8Array(base64String: string): Uint8Array<ArrayBuffer> {\n   const padding = '='.repeat((4 - (base64String.length % 4)) % 4)\n   const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/')\n   const rawData = window.atob(base64)\n-  const output = new Uint8Array(rawData.length)\n+  const output = new Uint8Array(new ArrayBuffer(rawData.length))\n   for (let i = 0; i < rawData.length; ++i) output[i] = rawData.charCodeAt(i)\n   return output\n }\n \n"
                }
            ],
            "date": 1770982396939,
            "name": "Commit-0",
            "content": "'use client'\n\nimport { useState, useEffect } from 'react'\nimport { Bell, BellOff } from 'lucide-react'\nimport { Button } from '@/components/ui/button'\nimport Link from 'next/link'\nimport toast from 'react-hot-toast'\n\nconst VAPID_PUBLIC_KEY = process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY\n\nfunction urlBase64ToUint8Array(base64String: string): Uint8Array {\n  const padding = '='.repeat((4 - (base64String.length % 4)) % 4)\n  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/')\n  const rawData = window.atob(base64)\n  const output = new Uint8Array(rawData.length)\n  for (let i = 0; i < rawData.length; ++i) output[i] = rawData.charCodeAt(i)\n  return output\n}\n\nexport function PushSubscribeButton({\n  shopId,\n  shopSlug,\n}: {\n  shopId: string\n  shopSlug: string\n}) {\n  const [status, setStatus] = useState<'idle' | 'loading' | 'subscribed' | 'unsupported' | 'ios-need-pwa'>('idle')\n  const [isIOS, setIsIOS] = useState(false)\n  const [isStandalone, setIsStandalone] = useState(false)\n\n  useEffect(() => {\n    const ua = navigator.userAgent\n    setIsIOS(/iPad|iPhone|iPod/.test(ua) && !(window as any).MSStream)\n    setIsStandalone(\n      (window as any).matchMedia('(display-mode: standalone)').matches ||\n        (navigator as any).standalone === true\n    )\n  }, [])\n\n  async function handleSubscribe() {\n    if (!VAPID_PUBLIC_KEY) {\n      toast.error('알림 설정이 되어 있지 않습니다.')\n      return\n    }\n    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {\n      setStatus('unsupported')\n      toast.error('이 브라우저에서는 알림을 지원하지 않아요.')\n      return\n    }\n\n    setStatus('loading')\n    try {\n      const reg = await navigator.serviceWorker.ready\n      let sub = await reg.pushManager.getSubscription()\n      if (!sub) {\n        const permission = await Notification.requestPermission()\n        if (permission !== 'granted') {\n          toast.error('알림을 허용해 주세요.')\n          setStatus('idle')\n          return\n        }\n        sub = await reg.pushManager.subscribe({\n          userVisibleOnly: true,\n          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),\n        })\n      }\n\n      const subJson = sub.toJSON()\n      const keys = subJson.keys\n      if (!keys?.p256dh || !keys?.auth) throw new Error('구독 정보를 읽을 수 없습니다')\n\n      const res = await fetch('/api/push/subscribe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          shopId,\n          endpoint: sub.endpoint,\n          keys: { p256dh: keys.p256dh, auth: keys.auth },\n        }),\n      })\n\n      if (!res.ok) {\n        const data = await res.json().catch(() => ({}))\n        throw new Error(data.error || '구독에 실패했습니다')\n      }\n\n      setStatus('subscribed')\n      toast.success('새 상품 알림을 켰어요!')\n    } catch (e: any) {\n      setStatus('idle')\n      toast.error(e?.message || '알림 구독에 실패했어요.')\n    }\n  }\n\n  // iOS: 푸시는 홈 화면에 추가한 PWA에서만 동작\n  if (isIOS && !isStandalone) {\n    return (\n      <p className=\"text-xs text-stone-500\">\n        <Link href={`/${shopSlug}/install-guide`} className=\"underline hover:text-stone-700\">\n          홈 화면에 추가\n        </Link>\n        한 뒤 알림을 받을 수 있어요.\n      </p>\n    )\n  }\n\n  if (status === 'unsupported') return null\n  if (status === 'subscribed') {\n    return (\n      <span className=\"inline-flex items-center gap-1.5 text-sm text-stone-500\">\n        <Bell className=\"h-4 w-4 text-emerald-500\" />\n        알림 켜짐\n      </span>\n    )\n  }\n\n  return (\n    <Button\n      type=\"button\"\n      variant=\"outline\"\n      size=\"sm\"\n      disabled={status === 'loading'}\n      onClick={handleSubscribe}\n      className=\"gap-1.5 border-stone-200 text-stone-700 hover:bg-stone-50\"\n    >\n      {status === 'loading' ? (\n        '등록 중...'\n      ) : (\n        <>\n          <BellOff className=\"h-4 w-4\" />\n          새 상품 알림 받기\n        </>\n      )}\n    </Button>\n  )\n}\n"
        }
    ]
}